{% comment %}
  Video v2 (full-width)
  - If a Shopify-hosted video is selected, we build a <video> element with its sources.
  - Otherwise, we embed a YouTube/Vimeo iframe from the provided URL.
  - Optional cover image becomes the video poster.
{% endcomment %}
{%- assign sid = section.id -%}

{%- assign ratio = section.settings.aspect_ratio -%}
{%- if ratio == '21-9' -%}
  {%- assign pad = 42.857 | append: '%' -%}
{%- elsif ratio == '4-3' -%}
  {%- assign pad = 75 | append: '%' -%}
{%- elsif ratio == '1-1' -%}
  {%- assign pad = 100 | append: '%' -%}
{%- else -%}
  {%- assign pad = 56.25 | append: '%' -%}
{%- endif -%}

<section id="vid2-{{ sid }}" class="vid2">
  <div class="vid2__outer">
    <div class="vid2__frame" style="--ar: {{ pad }};">
      {%- if section.settings.shopify_video != blank -%}
        {%- assign v = section.settings.shopify_video -%}
        <video
          class="vid2__media"
          autoplay
          muted
          loop
          playsinline
          preload="metadata"
          {% if section.settings.cover_image %}
            poster="{{ section.settings.cover_image | image_url: width: 2400 }}"
          {% endif %}
          aria-label="{{ section.settings.alt | escape }}"
        >
          {%- for s in v.sources -%}
            <source src="{{ s.url }}" type="{{ s.mime_type }}">
          {%- endfor -%}
          {{ section.settings.alt | escape }}
        </video>

      {%- elsif section.settings.embed_url != blank -%}
        {%- assign url = section.settings.embed_url | strip -%}
        {%- assign iframe_src = '' -%}

        {%- if url contains 'youtu.be/' -%}
          {%- assign yt_id = url | split: 'youtu.be/' | last | split: '?' | first -%}
        {%- elsif url contains 'watch?v=' -%}
          {%- assign yt_id = url | split: 'watch?v=' | last | split: '&' | first -%}
        {%- elsif url contains 'youtube.com/embed/' -%}
          {%- assign yt_id = url | split: 'embed/' | last | split: '?' | first -%}
        {%- endif -%}

        {%- if yt_id -%}
          {%- assign yt_params = '?rel=0&autoplay=1&mute=1&controls=0&showinfo=0&modestbranding=1&playsinline=1&loop=1&playlist=' | append: yt_id -%}
          {%- assign iframe_src = 'https://www.youtube-nocookie.com/embed/' | append: yt_id | append: yt_params -%}
        {%- elsif url contains 'vimeo.com/' -%}
          {%- assign vimeo_id = url | split: 'vimeo.com/' | last | split: '?' | first | split: '/' | last -%}
          {%- assign iframe_src = 'https://player.vimeo.com/video/' | append: vimeo_id | append: '?background=1&autoplay=1&muted=1&loop=1' -%}
        {%- endif -%}

        {%- if iframe_src != blank -%}
          <iframe
            class="vid2__media vid2__embed"
            src="{{ iframe_src }}"
            title="{{ section.settings.alt | escape }}"
            allow="autoplay; fullscreen; picture-in-picture"
            allowfullscreen
            loading="lazy"
            aria-hidden="true"
          ></iframe>
        {%- else -%}
          <div class="vid2__fallback">
            Please provide a valid YouTube or Vimeo URL.
          </div>
        {%- endif -%}

      {%- else -%}
        <div class="vid2__fallback">
          Please provide a valid YouTube or Vimeo URL.
        </div>
      {%- endif -%}
    </div>
  </div>
</section>

{% stylesheet %}
/* --- Full-bleed wrapper (break out of page width) --- */
#vid2-{{ sid }}.vid2{
  width: 100vw;
  margin-left: calc(50% - 50vw);
  margin-right: calc(50% - 50vw);
  background: #1110; /* transparent fallback */
}

/* Containing block for aspect ratio */
#vid2-{{ sid }} .vid2__outer{
  width: 100%;
}

/* Ratio box */
#vid2-{{ sid }} .vid2__frame{
  position: relative;
  width: 100%;
}
#vid2-{{ sid }} .vid2__frame::before{
  content: "";
  display: block;
  padding-top: var(--ar, 56.25%);
}

/* Media fits the box */
#vid2-{{ sid }} .vid2__media{
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  display: block;
  background: #000; /* letterbox behind video */
  object-fit: cover;
  pointer-events: none;
}

/* Fallback text */
#vid2-{{ sid }} .vid2__fallback{
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  color: #fff;
  background: #000;
  font-size: 16px;
}
{% endstylesheet %}

{% schema %}
{
  "name": "Video v2",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "video",
      "id": "shopify_video",
      "label": "Shopify-hosted video"
    },
    {
      "type": "url",
      "id": "embed_url",
      "label": "YouTube or Vimeo URL (used only if no Shopify video selected)",
      "info": "Examples: https://youtu.be/VIDEO_ID, https://www.youtube.com/watch?v=VIDEO_ID, https://vimeo.com/VIDEO_ID"
    },
    {
      "type": "image_picker",
      "id": "cover_image",
      "label": "Cover image (poster for Shopify video)"
    },
    {
      "type": "text",
      "id": "alt",
      "label": "Video alt text / title",
      "default": "Promotional video"
    },
    {
      "type": "select",
      "id": "aspect_ratio",
      "label": "Aspect ratio",
      "default": "16-9",
      "options": [
        { "value": "21-9", "label": "21:9 (ultra-wide)" },
        { "value": "16-9", "label": "16:9 (default)" },
        { "value": "4-3",  "label": "4:3" },
        { "value": "1-1",  "label": "1:1 (square)" }
      ]
    }
  ],
  "presets": [
    { "name": "Video v2" }
  ]
}
{% endschema %}
