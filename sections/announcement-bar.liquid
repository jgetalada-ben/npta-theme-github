{% comment %}
  Announcement Rotator
  - Up to 4 rich-text announcements that fade in/out
  - Background + text color + padding + speed controls
{% endcomment %}

<section id="AnnouncementBar-{{ section.id }}"
  style="background: {{ section.settings.bg_color | default: '#C8FF63' }}; padding: {{ section.settings.padding_y | default: 12 }}px 0;"
  class="announcement-rotator-section">

  <div class="announcement-bar--container page-container">
    <div class="announcement-rotator" role="region" aria-live="polite">
      {% if section.blocks.size > 0 %}
        {% for block in section.blocks %}
          {% if block.type == 'message' %}
            <div class="announcement{% if forloop.first %} is-active{% endif %}" {{ block.shopify_attributes }}>
              <div class="rt">{{ block.settings.text }}</div>
              {% if block.settings.link_label != blank and block.settings.link_url != blank %}
                <a class="ann-link" href="{{ block.settings.link_url }}">{{ block.settings.link_label }}</a>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <div class="announcement is-active">
          <div class="rt">ðŸŽ‰ FLASH SALE! BUY MORE, SAVE MORE!</div>
          <a class="ann-link" href="/collections/all">Shop now</a>
        </div>
      {% endif %}
    </div>
  </div>

  {% stylesheet %}
  /* Layout / colors */
  #AnnouncementBar-{{ section.id }} {
    color: {{ section.settings.text_color | default: '#000000' }};
  }
  #AnnouncementBar-{{ section.id }} .announcement-bar--container {
    display:flex; justify-content:center; align-items:center; position:relative;
    padding: 0 12px;
  }

  /* Rotator sizing: stack slides on top of each other, container keeps tallest height */
  #AnnouncementBar-{{ section.id }} .announcement-rotator {
    position: relative;
    width: 100%;
  }
  #AnnouncementBar-{{ section.id }} .announcement {
    position: absolute; left: 0; right: 0; top: 0;
    margin: 0; text-align: center;
    opacity: 0; transform: translateY(6px);
    transition: opacity 300ms ease, transform 300ms ease;
    pointer-events: none;
  }
  #AnnouncementBar-{{ section.id }} .announcement.is-active {
    opacity: 1; transform: translateY(0); pointer-events: auto; position: relative;
  }

  /* Typography â€” matches Figma (Anton 20 / 100%) with graceful fallback */
  #AnnouncementBar-{{ section.id }} .rt {
    font-family: 'Anton', var(--font-heading-family, var(--font-body-family));
    font-weight: 400; font-style: normal;
    font-size: {{ section.settings.font_size | default: 20 }}px;
    line-height: 100%;
    letter-spacing: 0;
    color: inherit;
  }
  /* Remove default margins Word/Docs may inject */
  #AnnouncementBar-{{ section.id }} .rt p { margin: 0; }
  #AnnouncementBar-{{ section.id }} .rt p + p { margin-top: .25rem; }

  #AnnouncementBar-{{ section.id }} .ann-link {
    margin-left: .5ch;
    color: inherit;
    text-decoration: underline;
    font-family: inherit;
    font-size: inherit;
    line-height: inherit;
    white-space: nowrap;
  }

  @media (max-width: 640px) {
    #AnnouncementBar-{{ section.id }} .rt { font-size: {{ section.settings.font_size | default: 20 | minus: 2 }}px; }
  }
  @media (prefers-reduced-motion: reduce){
    #AnnouncementBar-{{ section.id }} .announcement { transition: none; }
  }
  {% endstylesheet %}

  {% javascript %}
    (function(){
      var root = document.getElementById('AnnouncementBar-{{ section.id }}');
      if (!root) return;

      var slides = [].slice.call(root.querySelectorAll('.announcement-rotator .announcement'));
      if (!slides.length) return;

      var rot = root.querySelector('.announcement-rotator');

      // Fix container height to tallest slide
      function setHeight(){
        var max = 0;
        slides.forEach(function(s){
          var wasActive = s.classList.contains('is-active');
          s.classList.add('is-active');               // ensure measurable
          var h = s.offsetHeight;
          if (h > max) max = h;
          if (!wasActive) s.classList.remove('is-active');
        });
        rot.style.minHeight = max + 'px';
      }
      setHeight();
      window.addEventListener('resize', setHeight);

      var i = 0;
      function show(k){
        slides.forEach(function(s, idx){ s.classList.toggle('is-active', idx === k); });
      }
      show(i);

      var speed = {{ section.settings.rotation_ms | default: 5000 | plus: 0 }};

      function start(){
        if (root._annTimer) clearInterval(root._annTimer);
        root._annTimer = setInterval(function(){
          i = (i + 1) % slides.length;
          show(i);
        }, speed);
      }

      if (slides.length > 1) start();  // always rotate, even if prefers-reduced-motion

      // Pause on hover (desktop)
      root.addEventListener('mouseenter', function(){ if (root._annTimer) clearInterval(root._annTimer); });
      root.addEventListener('mouseleave', function(){ if (slides.length > 1) start(); });

      // Clean up timer when Theme Editor hot-reloads this section
      document.addEventListener('shopify:section:unload', function(e){
        if (e.detail && e.detail.sectionId === '{{ section.id }}' && root._annTimer){
          clearInterval(root._annTimer);
        }
      });
    })();
  {% endjavascript %}
</section>

{% schema %}
{
  "name": "Announcement (rotating)",
  "tag": "section",
  "class": "section--announcement-bar",
  "max_blocks": 4,
  "settings": [
    { "type": "color", "id": "bg_color", "label": "Background color", "default": "#C8FF63" },
    { "type": "color", "id": "text_color", "label": "Text color", "default": "#000000" },
    { "type": "range", "id": "font_size", "label": "Font size", "min": 12, "max": 28, "step": 1, "unit": "px", "default": 20 },
    { "type": "range", "id": "padding_y", "label": "Top/bottom padding", "min": 0, "max": 48, "step": 2, "unit": "px", "default": 12 },
    { "type": "range", "id": "rotation_ms", "label": "Rotation speed", "min": 2000, "max": 9000, "step": 500, "unit": "ms", "default": 5000 }
  ],
  "blocks": [
    {
      "type": "message",
      "name": "Announcement",
      "settings": [
        { "type": "richtext", "id": "text", "label": "Announcement text", "default": "<p>ðŸŽ‰ FLASH SALE! BUY MORE, SAVE MORE!</p>" },
        { "type": "text", "id": "link_label", "label": "Link label", "default": "Shop now" },
        { "type": "url", "id": "link_url", "label": "Link URL" }
      ]
    }
  ],
  "presets": [{ "name": "Announcement (rotating)" }]
}
{% endschema %}
